//https://book-elements.github.io
!(async function({Array:e,console:t,customElements:s,CustomEvent:a,document:n,fetch:r,HTMLElement:i,localStorage:o,location:l,Object:c,navigator:h,setTimeout:d,URLSearchParams:p,Promise:m}=window){function g(...e){const s=e.shift();t.log(`%c ${s} `,"background:gold",...e)}const[b,u,w,y,f,x,k,v,$,C,E,A,_,R,S]="append,define,attachShadow,shadowRoot,innerHTML,getAttribute,setAttribute,querySelector,querySelectorAll,addEventListener,removeEventListener,whenDefined,then,onclick,part".split(","),z=!(l.host.includes("github.io")||l.host.includes("127.0.0.1")),T=e=>s.get(e),j=(e,t={})=>{const s=n.createElement(e);return t[b]&&(s[b](...t[b]),delete t[b]),t.style&&(c.assign(s.style,t.style),delete t.style),t.attrs&&(c.entries(t.attrs).forEach((([e,t])=>s[k](e,t))),delete t.attrs),c.assign(s,t)},N=(e,t={})=>j("style",{textContent:e,...t}),I=(e=l.search)=>new p(e),L=(e,t="")=>I().get(e)||o.getItem(e)||t,M=e=>I().has(e),O=I(n.currentScript.src.split("?")[1]),P=O.get("prefix")||"book",B=O.get("chapterprefix")||"";g("Component Prefix - exempt: <book-reader> = ",P);const D="civilaization",U="book",[q,H,F,J,K,V,W]=["english","lang","nr","translate","languages","count","chapter"],G="en",Q=L(q,"gb"),X="h2",Y="chapterNr",Z="add-chapter",ee="language-changed",te="another-chapter",se="paragraph-at-top",ae="chapter-highlight",ne="chapter-number";n.head[b](j("script",{src:"https://toast-message.github.io/element.js",onload:()=>g("<toast-message> loaded with <script> and defined")}));const re=e=>{n[v]("toast-message")&&window.showToastMessage(e)},ie="connectedDoneCallback",oe="renderedCallback",le="renderedOnceCallback",ce="@keyframes fadeIn{from{opacity:0}to{opacity:1}}{name}{animation:fadeIn 1s forwards}",he="chapterlabel",de="chaptertitle",pe={AREA51:{name:"book-reader",css:":host{font:18px arial;margin:0 auto;padding:0;max-width:1024px}:host{--radius:6px;--titlebackground:lightblue;--textcolor:beige;--aicolor:gold;--chaptertitle:#9C2E35;--chapteractions:indianred;--scrollblock:var(--chaptertitle);--scrollbar:#eee;var(--titlebackground);--chapter-title-size:1.2em;}@keyframes fadeOut{from{opacity:1}to{opacity:0}}.fade-out{animation:fadeOut 1s forwards}"+ce+':host{height:95vh;overflow:hidden}:host{display:grid;gap:var(--radius);grid-template-rows:auto 1fr;grid-template-columns:40px 1fr;grid-template-areas:"header header" "left right"}',shadowRoot:"open"},w3:{name:P+"-title",css:"{name}{user-select:none;grid-area:header}{name} h1{padding:0.25em;background:var(--titlebackground);color:var(--textcolor);margin-block:0;border-radius:var(--radius)}{name} h1{text-shadow:1px 1px 1px black}"+ce+"{name} span{font-style:italic;color:var(--aicolor)}"},w1:{name:P+"-chapter-numbers",css:`{name}{user-select:none;grid-area:left;display:flex;flex-direction:column}.${ne}{display:flex;flex:1;align-items:center;justify-content:center}.${ne}{opacity:.5;margin-bottom:.2em;border-radius:var(--radius);background:lightblue;cursor:pointer}.${ae}{opacity:1;background:var(--chaptertitle);color:var(--textcolor)}`+ce},w2:{name:P+"-chapter-number",css:""},w5:{name:B+"chapter-title",css:`{name}{display:block;position:sticky;top:0em;padding:.3em .5em;user-select:none;margin-block:0;background:var(--chaptertitle);color:var(--textcolor);border-top-left-radius:var(--radius);text-shadow:1px 1px 1px black}[part='${he}']{display:block;font-size:0.6em}[part='${de}']{font-size:var(--chapter-title-size);margin-block:0em}`},w6:{name:B+"chapter-actions",css:"{name}{background:var(--chapteractions);display:flow-root;border-bottom-left-radius:var(--radius)}{name}{position:sticky;xtop:2.5em}"},wa:{name:P+"-chapters",css:"{name}{display:flex;flex-direction:column;grid-area:right}{name}{border-radius:var(--radius)}{name}{overflow-y:scroll;scroll-behavior:smooth;scroll-margin:3em;scrollbar-width:auto;scrollbar-color:var(--scrollblock) var(--scrollbar)}"},wb:{name:P+"-chapter",css:"{name}{background:beige}"+ce},w4:{name:B+"chapter-paragraphs",css:"{name}{display:block;margin:0 0.5em}{name} p{text-wrap:pretty}"},w7:{name:"svg-flag",css:""},wc:{name:"flag-baseclass",shadowRoot:"open",css:"img{width:var(--flagsize,40px);margin:5px;cursor:pointer}"},wd:{name:"translate-languages",css:""},we:{name:"language-choices",css:`:host{position:relative;float:right;right:4px}:host{--flagsize:1em}:host([${J}]){opacity:.2}`},wf:{name:"language-flag",css:""},wg:{name:"translate-flag",css:""},w8:{name:"svg-icon",css:"{name}{float:right;margin:5px}{name} svg:hover{cursor:pointer;stroke:beige;fill:beige}"},w9:{name:"chapter-github-link",css:""}};g(`Web Components: (${P}-elements)`,c.keys(pe).map((e=>"<"+pe[e].name+">")).join(", "));const me=e=>pe[e].css.replaceAll("{name}",pe[e].name),ge=class extends i{b({type:e,func:t=(()=>"voodoo"),scope:s=n,options:a={}}){s[C](e,t,a);let r=()=>s[E](e,t,a);return this.bers=this.bers||[],this.bers.push(r),r}d({type:e="CustomEvent",detail:t={},bubbles:s=!0,composed:n=!0,scope:r=this}){r.dispatchEvent(new a(e,{detail:t,bubbles:s,composed:n}))}e(e,t=this){return t&&t!=n&&t!=window&&t.closest(e)||this.e(e,t?.getRootNode()?.host||t?.parentNode)}get y(){return this.e(pe.AREA51.name)}get t(){return this.y[y]}get h(){return this.t[v](pe.wa.name)}get w(){return[...this.h[$](pe.wb.name)]}get i(){return this.e(pe.wb.name)}get g(){return this.i?.[F]}j(e){return this.t[v](pe.wb.name+`[${F}="${e}"]`)}k(e){return[...this.t[$](`[id^="p-${e}-"]`)]}r(e){return this.k(e)[0]}s(e){return this.k(e).slice(-1)[0]}$currentChapterNumber(){}a({element:e=this,block:s="start",behavior:a="smooth",inline:n="nearest"}){e?(e.scrollIntoView({behavior:a,block:s,inline:n}),this.b({type:"scrollend",scope:this.h,options:{once:!0}})):t.error("no scroll",e)}l(e,t=this.j(e)){this.a({element:t})}get m(){return L(H,G)}set m(e){const t=new p(l.search),s=L("reload",!1);t.set(H,e),o.setItem(H,e),history.pushState({},"","?"+t.toString()),s?l.search=t.toString():this.d({type:ee,detail:e,scope:n})}get v(){return l.href.substring(0,l.href.lastIndexOf("/"))}get x(){return"/book/"+(this.y[x](U)||D)}get u(){let e;if(this.y.hasAttribute(U))e="."+this.x;else{const s=this.y[x]("src"),a=this.v+this.x;t.error("get u",s,a),e=s||a}return e}set u(e){g("set u",e),this[k]("src",e)}n(e,t={},s=e.name,a=s){return j(s,{[S]:a.replace(P+"-",""),...t})}async o({src:e=!1,lang:t=this.m,nr:s=1}){e||(("us"==t||"gb"==t)&&(t=G),e=this.u+`/chapters/chapter-${s}-${t}.md?fetchChapter`);try{const t=await r(e);return t.ok?await t.text():t.status}catch(t){return`## Error:${t.message}: `+e.split("/").slice(-1)}}p({nr:e=1,lang:t=G,action:s="defaultJSON"}){let a;return a=this.y.src?this.y.src+`/api.php?action=${s}`+`&${F}=`+e+`&${H}=`+t:this.v+this.x+"/allchapters.json",a}get q(){let e=c.keys(this.y.b3).reverse(),t=L(J,"");t=[...t].filter((e=>2==e.length));let s=(a=new Set(e),n=new Set(t),new Set([...a,...n]));var a,n;return s=[...s],s}connectedCallback(){this[ie]&&this[ie](),this[oe]&&d((()=>this[oe]())),this[le]&&d((()=>{this[le](),delete this[le]}))}};s[u](pe.AREA51.name,class extends ge{static get observedAttributes(){return["src","book"]}attributeChangedCallback(e,s,a){this.isConnected&&t.warn("attributeChanged:",e,s,a)}constructor(){super()[w]({mode:pe.AREA51[y]})[b](j("all_styles_easy_wrap",{id:"main",append:[N(me("AREA51")+me("w3"),{id:"book_elements"}),N(me("w1")+me("wa")+me("wb")+me("w5")+me("w6")+me("w4")+me("w8"),{id:"chapter_elements"}),this.titles=N(pe.wa.name+` [part="${he}"],`+pe.wa.name+` ${pe.w4.name},`+pe.wa.name+` ${pe.w6.name}{display:none}`,{id:"toggle_titles",onload:()=>{this.titles.disabled=!M("titles")}})]})),this.b4=[],this.firstlastParagraphElements=[]}async[oe](){this.b({type:te,func:e=>{o.setItem(Y,e.detail.parentNode[F])}}),this.y.b6=L(W,o.getItem(Y)||1),isNaN(this.y.b6)&&(this.y.b6=1),d((()=>{re("Book loaded. Chapter: "+this.y.b6),this.l(this.y.b6)}),500)}[ie](){this.z()}async z(e=this){let s;e.b3=await(await r(e.p({}))).json(),g("renderBook:",{[P]:e.u,chapters:e.b3,area51:{src:this.y.src,[U]:this.y[x](U),default:this.x,dbpassword:"R0deHar1ng"}});let a=0;for(const[t,n]of c.entries(e.b3))n.length>a&&(s=t,a=n.length);e.a1=L(V,a),e[y][b](this.n(pe.w3),this.n(pe.w1),this.n(pe.wa));const i={PageUp:t=>{e.y.b6>1&&e.l(e.y.b6-1)},PageDown:t=>{e.y.b6<e.a1&&e.l(e.y.b6+1)},ArrowUp:t=>{e.h.scrollBy(0,-200)},ArrowDown:t=>{e.h.scrollBy(0,200)},Home:t=>{e.a({element:e.r(e.y.b6),block:"center"})},End:t=>{e.a({element:e.s(e.y.b6),block:"center"})},t:t=>{e.toggletitles()}};d((()=>{g("UI keys",c.keys(i).join(", "))}),500),n[C]("keydown",(e=>{e.preventDefault(),i[e.key]?i[e.key](e):t.warn("Key",e.key)}))}toggletitles(e=undefined){this.titles.disabled=!this.titles.disabled}domtree(e=this[y][v]("h2")){n[C]("component-tree",(e=>{let s=[...e.composedPath()].reverse();s=s.slice(s.indexOf(n.body)+1,1/0);let a=0;g("simplified DOM tree"),s.forEach((e=>{t.log(" ".repeat(a),e),a++}))}),!0),e?.dispatchEvent(new a("component-tree",{bubbles:!0,composed:!0}))}}),s[u](pe.w3.name,class extends ge{[ie](){this[f]=`<h1>Civil<span>ai</span>zation ${((e,t="")=>`<${e}>${t}</${e}>`)(pe.we.name)}</h1>`}}),s[u](pe.we.name,class extends ge{[ie](e=pe.wf.name){const t="language-select";d((()=>{import("https://language-select.github.io/select-button.min.js")[_]((()=>{g("<language-select> imported and defined")}))}),1),this[w]({mode:"open"})[b](N(t+"{float:right;font-size:80%}"+t+":hover{color:steelblue}"+t+"::part(svg){min-width:1em}"),j(t,{attrs:{selected:this.m,languages:this.y.q}})),this.b({type:t,func:e=>{this.m=e.detail.iso},scope:n})}}),s[A](pe.w7.name)[_]((()=>{s[u](pe.wc.name,class extends((e=>class extends ge{})(T(pe.w7.name))){get y(){return this.e(pe.AREA51.name)}connectedCallback(e=this){let t=j(pe.w7.name),s=e[H]||e[x](H)||e[x]("is");s==G&&(s=Q),t[k]("is",s),e[w]({mode:pe.wc[y]})[b](N(me("wc")),t),e[ie]&&e[ie](),e[oe]&&e[oe]()}}),s[u](pe.wd.name,class extends(T(pe.we.name)){[ie](){this.toggleAttribute(J,M(J))&&super[ie](pe.wg.name)}}),s[u](pe.wf.name,class extends(T(pe.wc.name)){[ie](){this[R]=()=>{this.m=this[H]}}}),s[u](pe.wg.name,class extends(T(pe.wc.name)){[ie](e=this,s=this.g,a=this[H]){e[R]=async()=>{t.log(`Translate ${s} -> ${a}`),re(`Translating ${a.toUpperCase()}`),e.style.opacity=.3;let n="";if(z)n=await e.o({src:e.p({nr:s,lang:a,action:J})});else{const e=Math.floor(3001*Math.random())+2e3;await new m((t=>d(t,e)))}t.log(`Translated ${s} -> ${a}`,n.length,"chars"),re(`Translated ${a.toUpperCase()}`),e.remove()}}[oe](){try{this.o({[H]:this[H],[F]:this.g})}catch(e){}}})})),s[u](pe.wa.name,class extends ge{[ie](){this[b](...e.from({length:this.y?.a1},((e,t)=>this.n(pe.wb,{[F]:++t}))));let t,s=0;const a=()=>{s=this.scrollTop;for(const e of this.w){const t=e.getBoundingClientRect(),s=600;if(t.top<=s&&t.bottom>=s-300){this.d({type:se,detail:e[v](pe.w4.name)[v]("p")});break}}};this.b({type:"scroll",func:()=>{return e=a,clearTimeout(t),void(t=d(e,200));var e},scope:this})}}),s[u](pe.wb.name,class extends ge{set b1(e){this._b1[f]="",this._b1[b](this.n(pe.w4,{[f]:e}))}get b1Markdown(){let e="##"+this[v](X).innerText+"\n";return e+=this._b1[f],h.clipboard.writeText(e)[_]((()=>re("Chapter text copied to clipboard"))).catch((e=>t.error("Failed to copy text: ",e))),e}async[ie](){this.b2()}async b2(e=this){e[k](H,this.m),e[k](F,e[F]);let t=await e.o({[H]:this.m,[F]:e[F]});404==t?re(`Chapter ${e[F]} not found`):(e[f]="",e[b](e._b1=j(pe.w4.name,{[f]:t})),e.d({type:Z,detail:e}))}[oe](){this.b({type:ee,func:e=>{this.y.classList.add("fade-out"),this.b2()},scope:n})}}),s[u](pe.w9.name,class extends ge{[oe](){const{nr:e,lang:t}=this.i;this[b](be({is:"github",[R]:s=>{n.location.href=`https://github.com/${D}/${D}.github.io/blob/main/book/${D}/chapters/chapter-${e}-${t}.md`}}))}}),s[u](pe.w4.name,class extends ge{[oe](e=this){e[F]=e.g,e[f]=[[/#{3}\s?([^\n]+)/g,"<h3>$1</h3>"],[/#{2}\s?([^\n]+)/g,"<h2>$1</h2>"],[/#{1}\s?([^\n]+)/g,"<h1>$1</h1>"],[/\*\*\s?([^\n]+)\*\*/g,"<b>$1</b>"],[/_([^_`]+)_/g,"<i>$1</i>"],[/([^\n]+\n?)/g,"<p>$1</p>"],[/([^\n]+)(\*)([^\n]+)/g,"<ul><li>$3</li></ul>"],[/!\[([^\]]+)\]\(([^)]+)\s"([^")]+)"\)/g,'<img src="$2" alt="$1" title="$3">'],[/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2">$1</a>']].reduce(((e,[t,s])=>e.replace(t,s)),e[f]),e[$]("p:empty").forEach((e=>e.remove()));let s=[...e[$]("p")];this.y.b4.push(...s.map(((t,s)=>(t.id=`p-${e[F]}-${++s}`,t)))),this.y.firstlastParagraphElements.push(s[0],s.slice(-1)[0]);let a=e[v](X);if(a){let[t,s]=a.textContent.split(":");a.remove(),e.before(this.n(pe.w5,{append:[j("span",{[S]:he,[f]:t}),j(X,{[S]:de,[f]:s})]}),this.n(pe.w6,{append:[j(pe.w9.name),j(pe.wd.name)]}))}else t.error(`No ${X} Markdown ## found in chapter`,e[F])}}),s[u](pe.w2.name,class extends ge{[oe](){const e=this[F];this[f]=e;const t=t=>{const s=t==e;this.classList.toggle(ae,s),s&&(this.y.b6=e,this.d({type:te,detail:this}))};this.style.order=e,this.classList.add(ne),t(this.y.b6),this[R]=()=>{t(e),this.l(e)},this.b({type:se,func:e=>{const s=e.detail.parentNode[F];t(s)}})}}),s[u](pe.w1.name,class extends ge{[oe](){this.b({type:Z,func:e=>{const t=e.detail;t.b5||this[b](t.b5=this.n(pe.w2,{[F]:t[F]}))}})}});const be=e=>j(pe.w8.name,e);s[u](pe.w8.name,class extends i{connectedCallback(e=this.is||this[x]("is")){this[f]={github:'<svg width="30px" viewBox="0 0 96 96"><path d="m49.3 0c-27 0-49 22-49 49 0 22 14 40 33 47 2 0 3-1 3-2 0-1 0-5 0-9-14 3-16-6-16-6-2-6-5-7-5-7-4-3 0-3 0-3 5 0 8 5 8 5 4 7 11 5 14 4 0-3 2-5 3-7-11-1-22-5-22-24 0-5 2-10 5-13 0-1-2-6 0-13 0 0 4-1 13 5a47 47 0 0112-2c4 0 8 1 12 2 9-6 13-5 13-5 3 7 1 12 0 13 3 3 5 8 5 13 0 19-11 23-22 24 2 2 3 4 3 9 0 7 0 12 0 14 0 1 1 3 3 2 19-7 33-25 33-47 3-27-19-49-46-49z"/></svg>'}[e],this[k]("part","icon_"+e)}})})();